<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UHAS Medical Students Residential Data</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #1a5fb4;
            --secondary: #1c71d8;
            --accent: #2ec27e;
            --danger: #c9190b;
            --warning: #e5a50a;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 15px;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .app-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            overflow: hidden;
            position: relative;
            min-height: 100vh;
        }
        
        /* Header */
        .app-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 25px 20px;
            text-align: center;
        }
        
        .logo {
            font-size: 40px;
            margin-bottom: 10px;
        }
        
        h1 {
            font-size: 22px;
            margin-bottom: 8px;
        }
        
        .subtitle {
            opacity: 0.9;
            font-size: 13px;
        }
        
        /* Sync Status */
        .sync-status {
            position: absolute;
            top: 15px;
            right: 15px;
            background: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .sync-status.online {
            color: var(--accent);
            border: 1px solid var(--accent);
        }
        
        .sync-status.offline {
            color: var(--warning);
            border: 1px solid var(--warning);
        }
        
        /* Form */
        .form-container {
            padding: 20px;
        }
        
        .section {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .section-title {
            color: var(--primary);
            font-size: 16px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #444;
            font-size: 14px;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: var(--primary);
            outline: none;
        }
        
        /* Student Search */
        .search-container {
            position: relative;
        }
        
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid var(--primary);
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: none;
        }
        
        .search-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        
        .search-item:hover {
            background: #f5f9ff;
        }
        
        .student-info {
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
        }
        
        /* Block & Room Selection */
        .blocks-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .block-btn {
            padding: 14px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            font-weight: 600;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .block-btn.selected {
            border-color: var(--primary);
            background: #f0f7ff;
            color: var(--primary);
        }
        
        .rooms-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            max-height: 250px;
            overflow-y: auto;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 8px;
        }
        
        .room-btn {
            padding: 10px 6px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            text-align: center;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .room-btn:hover {
            background: #f0f7ff;
            border-color: var(--primary);
        }
        
        .room-btn.selected {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        /* Room section container */
        .room-section {
            display: none;
        }
        
        .room-section.active {
            display: block;
        }
        
        /* Buttons */
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 25px;
        }
        
        .btn {
            padding: 16px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:active {
            background: #154c8c;
            transform: translateY(2px);
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--accent);
            color: white;
            padding: 14px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            transition: transform 0.3s;
            max-width: 90%;
            text-align: center;
        }
        
        .toast.show {
            transform: translateX(-50%) translateY(0);
        }
        
        /* Loading */
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 15px;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Instructions */
        .instructions {
            background: #fff9e6;
            border-left: 4px solid var(--warning);
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 0 8px 8px 0;
            font-size: 13px;
        }
        
        @media (max-width: 768px) {
            .blocks-grid {
                grid-template-columns: 1fr;
            }
            
            .rooms-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .action-buttons {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 480px) {
            .rooms-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sync Status -->
        <div class="sync-status" id="syncStatus">
            <i class="fas fa-sync"></i>
            <span id="statusText">Loading...</span>
        </div>
        
        <!-- Header -->
        <div class="app-header">
            <div class="logo">üè•</div>
            <h1>UHAS ASOGLI HALL</h1>
            <p class="subtitle">Medical Students Residential Data Collection</p>
        </div>
        
        <!-- Instructions -->
        <div class="instructions">
            <strong><i class="fas fa-info-circle"></i> INSTRUCTIONS:</strong> 
            1. Search student by ID/Name ‚Üí 2. Select block ‚Üí room ‚Üí bed ‚Üí 3. Submit
        </div>
        
        <!-- Loading Overlay -->
        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            <div id="loadingText">Loading student database...</div>
        </div>
        
        <!-- Main Form -->
        <div class="form-container">
            <form id="auditForm">
                <!-- Executive Section -->
                <div class="section">
                    <h2 class="section-title"><i class="fas fa-user-tie"></i> Executive Details</h2>
                    
                    <div class="form-group">
                        <label for="executiveName">Your Name *</label>
                        <input type="text" id="executiveName" required placeholder="Enter your full name">
                    </div>
                    
                    <div class="form-group">
                        <label for="executiveID">Executive ID *</label>
                        <input type="text" id="executiveID" required placeholder="Your ID number">
                    </div>
                    
                    <div class="form-group">
                        <label for="auditDate">Audit Date *</label>
                        <input type="date" id="auditDate" required>
                    </div>
                </div>
                
                <!-- Student Search -->
                <div class="section">
                    <h2 class="section-title"><i class="fas fa-search"></i> Find Student</h2>
                    
                    <div class="form-group">
                        <label>Search Student (ID or Name) *</label>
                        <div class="search-container">
                            <input type="text" id="studentSearch" required 
                                   placeholder="Enter index number or name" autocomplete="off">
                            <div class="search-results" id="searchResults"></div>
                        </div>
                    </div>
                    
                    <!-- Student Info Display -->
                    <div class="student-info" id="studentInfo">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div>
                                <label>Student ID</label>
                                <input type="text" id="studentID" readonly>
                            </div>
                            <div>
                                <label>Full Name</label>
                                <input type="text" id="studentName" readonly>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                            <div>
                                <label>Level</label>
                                <input type="text" id="studentLevel" readonly>
                            </div>
                            <div>
                                <label>Programme</label>
                                <input type="text" id="studentProgramme" readonly>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Hostel Details -->
                <div class="section">
                    <h2 class="section-title"><i class="fas fa-bed"></i> Hostel Assignment</h2>
                    
                    <div class="form-group">
                        <label>Select Hostel Block *</label>
                        <div class="blocks-grid">
                            <div class="block-btn" data-block="DOME">DOME</div>
                            <div class="block-btn" data-block="HLIHA">HLIHA</div>
                            <div class="block-btn" data-block="BANKOE">BANKOE</div>
                            <div class="block-btn" data-block="AHOE">AHOE</div>
                        </div>
                    </div>
                    
                    <!-- Room Selection -->
                    <div class="form-group room-section" id="roomSection">
                        <label>Select Room Number (1-40) *</label>
                        <div class="rooms-grid" id="roomsGrid"></div>
                    </div>
                    
                    <!-- Bed Selection -->
                    <div class="form-group">
                        <label for="bedSpace">Bed Space</label>
                        <select id="bedSpace">
                            <option value="">Select Bed</option>
                            <option value="Bed 1">Bed 1</option>
                            <option value="Bed 2">Bed 2</option>
                            <option value="Bed 3">Bed 3</option>
                            <option value="Bed 4">Bed 4</option>
                        </select>
                    </div>
                    
                    <!-- Notes -->
                    <div class="form-group">
                        <label for="notes">Notes / Observations</label>
                        <textarea id="notes" rows="2" placeholder="Any remarks..."></textarea>
                    </div>
                </div>
                
                <!-- Submit Buttons -->
                <div class="action-buttons">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane"></i> Submit Record
                    </button>
                    <button type="button" class="btn btn-secondary" id="clearBtn">
                        <i class="fas fa-redo"></i> Clear Form
                    </button>
                </div>
            </form>
            
            <!-- App Info -->
            <div style="text-align: center; margin-top: 30px; font-size: 12px; color: #666;">
                <p><i class="fas fa-database"></i> Connected to UHAS Student Database</p>
                <p id="studentCount">Loading student count...</p>
            </div>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <script>
    // ============== CONFIGURATION ==============
    const CONFIG = {
        // TEST URL: Try this CSV URL first
        STUDENT_DB_SHEET: "https://docs.google.com/spreadsheets/d/1gffuZSDnqPSZTQdwYe7Ee4mONQIrKh_sdHDjXWaZEyM/export?format=csv&gid=0",
        
        // Your Google Apps Script URL
        SUBMISSION_ENDPOINT: "https://script.google.com/macros/s/AKfycbxI8KyZQSuUsUtzZgQT71_JHCPnqcTs7jomfrK4-bW2JLlxWuOEWRZMA9AB3MdQm3K3/exec",
        
        ADMIN_EMAIL: "sewormnyuielove@gmail.com"
    };
    
    // ============== GLOBAL VARIABLES ==============
    let studentDatabase = [];
    let selectedBlock = "";
    let selectedRoom = "";
    let selectedStudent = null;
    
    // ============== INITIALIZATION ==============
    document.addEventListener('DOMContentLoaded', function() {
        console.log("App initialized");
        
        // Set today's date
        document.getElementById('auditDate').valueAsDate = new Date();
        
        // Setup UI
        generateRoomButtons();
        setupEventListeners();
        updateOnlineStatus();
        
        // Load student database
        loadStudentDatabase();
        
        // Load saved executive info
        loadExecutiveInfo();
        
        // Monitor network status
        window.addEventListener('online', function() {
            updateOnlineStatus();
            if (studentDatabase.length < 10) {
                loadStudentDatabase();
            }
        });
        window.addEventListener('offline', updateOnlineStatus);
        
        // Auto-save executive info
        document.getElementById('executiveName').addEventListener('input', saveExecutiveInfo);
        document.getElementById('executiveID').addEventListener('input', saveExecutiveInfo);
        
        // Add refresh button
        createRefreshButton();
    });
    
    // ============== GOOGLE SHEETS LOADING ==============
    async function loadStudentDatabase() {
        showLoading('Loading student database...');
        updateStatus('Loading...');
        
        try {
            const response = await fetch(CONFIG.STUDENT_DB_SHEET + "&_=" + Date.now());
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const csvText = await response.text();
            
            // Parse CSV
            studentDatabase = parseCSVData(csvText);
            
            if (studentDatabase.length === 0) {
                throw new Error("No students found in CSV data");
            }
            
            // Save to localStorage for offline use
            localStorage.setItem('uhas_student_db', JSON.stringify(studentDatabase));
            localStorage.setItem('uhas_student_db_updated', new Date().toISOString());
            
            updateStudentCount();
            showToast(`‚úÖ Loaded ${studentDatabase.length} students`, 'success');
            updateStatus(`${studentDatabase.length} students`);
            
        } catch (error) {
            console.error('Error loading database:', error);
            
            // Try loading from localStorage
            const savedData = localStorage.getItem('uhas_student_db');
            if (savedData) {
                studentDatabase = JSON.parse(savedData);
                console.log(`Loaded ${studentDatabase.length} students from cache`);
                showToast(`üìÇ Using cached data (${studentDatabase.length} students)`, 'info');
                updateStudentCount();
                updateStatus(`${studentDatabase.length} students (cached)`);
            } else {
                // Use sample data if no cache
                loadSampleData();
                showToast('‚ö†Ô∏è Using sample data. Check internet connection.', 'warning');
                updateStatus('Offline - Sample Data');
            }
        } finally {
            hideLoading();
        }
    }
    
    function parseCSVData(csvText) {
        const database = [];
        const lines = csvText.split('\n').filter(line => line.trim() !== '');
        
        if (lines.length < 2) {
            console.warn("CSV has no data rows");
            return database;
        }
        
        // Parse headers
        const headers = lines[0].split(',').map(h => h.trim());
        
        // Parse data rows
        for (let i = 1; i < lines.length; i++) {
            const row = lines[i];
            const values = parseCSVRow(row);
            
            if (values.length >= headers.length) {
                const student = {};
                
                // Map headers to values
                headers.forEach((header, index) => {
                    if (values[index]) {
                        student[header.toLowerCase()] = values[index].trim();
                    }
                });
                
                // Standardize field names
                const studentData = {
                    id: student.id || student['student id'] || student['index number'] || '',
                    name: student.name || student['student name'] || student['full name'] || '',
                    level: student.level || student['student level'] || '',
                    programme: student.programme || student['student programme'] || student.course || 'Medicine'
                };
                
                // Only add if we have ID and name
                if (studentData.id && studentData.name) {
                    database.push(studentData);
                }
            }
        }
        
        console.log(`Parsed ${database.length} students from CSV`);
        return database;
    }
    
    function parseCSVRow(row) {
        const values = [];
        let current = '';
        let inQuotes = false;
        
        for (let i = 0; i < row.length; i++) {
            const char = row[i];
            
            if (char === '"') {
                inQuotes = !inQuotes;
            } else if (char === ',' && !inQuotes) {
                values.push(current);
                current = '';
            } else {
                current += char;
            }
        }
        
        values.push(current);
        return values.map(v => v.replace(/^"|"$/g, '').trim());
    }
    
    function loadSampleData() {
        // Sample student data for testing
        studentDatabase = [
            { id: "UHA2101001", name: "John Mensah", level: "200", programme: "Medicine" },
            { id: "UHA2101002", name: "Alice Smith", level: "200", programme: "Medicine" },
            { id: "UHA2101003", name: "Kwame Addo", level: "300", programme: "Medicine" },
            { id: "UHA2101004", name: "Grace Osei", level: "300", programme: "Medicine" },
            { id: "UHA2101005", name: "David Amoah", level: "400", programme: "Medicine" },
            { id: "UHA2101006", name: "Sarah Darko", level: "400", programme: "Medicine" },
            { id: "UHA2101007", name: "Michael Agyeman", level: "100", programme: "Medicine" },
            { id: "UHA2101008", name: "Comfort Asante", level: "100", programme: "Medicine" },
            { id: "UHA2101009", name: "Prince Owusu", level: "200", programme: "Medicine" },
            { id: "UHA2101010", name: "Abigail Boateng", level: "200", programme: "Medicine" }
        ];
        
        updateStudentCount();
    }
    
    // ============== STUDENT SEARCH ==============
    document.getElementById('studentSearch').addEventListener('input', function(e) {
        const searchTerm = e.target.value.trim().toLowerCase();
        const resultsDiv = document.getElementById('searchResults');
        
        clearTimeout(this.searchTimeout);
        
        if (searchTerm.length < 2) {
            resultsDiv.style.display = 'none';
            return;
        }
        
        resultsDiv.innerHTML = '<div class="search-item">Searching...</div>';
        resultsDiv.style.display = 'block';
        
        this.searchTimeout = setTimeout(() => {
            performStudentSearch(searchTerm, resultsDiv);
        }, 300);
    });
    
    function performStudentSearch(searchTerm, resultsDiv) {
        if (studentDatabase.length === 0) {
            resultsDiv.innerHTML = '<div class="search-item">No student database loaded</div>';
            resultsDiv.style.display = 'block';
            return;
        }
        
        const results = studentDatabase.filter(student => {
            const idMatch = student.id.toLowerCase().includes(searchTerm);
            const nameMatch = student.name.toLowerCase().includes(searchTerm);
            return idMatch || nameMatch;
        });
        
        // Sort results
        results.sort((a, b) => {
            const aIdExact = a.id.toLowerCase() === searchTerm;
            const bIdExact = b.id.toLowerCase() === searchTerm;
            if (aIdExact && !bIdExact) return -1;
            if (!aIdExact && bIdExact) return 1;
            
            return parseInt(a.level) - parseInt(b.level);
        });
        
        const displayResults = results.slice(0, 15);
        
        if (displayResults.length === 0) {
            resultsDiv.innerHTML = '<div class="search-item">No students found</div>';
            resultsDiv.style.display = 'block';
            return;
        }
        
        resultsDiv.innerHTML = displayResults.map(student => `
            <div class="search-item" data-id="${student.id}">
                <div style="font-weight: bold; color: var(--primary);">${student.id}</div>
                <div style="font-size: 12px; color: #666; margin-top: 4px;">
                    ${student.name}
                </div>
                <div style="font-size: 11px; color: #888; margin-top: 2px;">
                    Level ${student.level} ‚Ä¢ ${student.programme}
                </div>
            </div>
        `).join('');
        
        resultsDiv.style.display = 'block';
        
        document.querySelectorAll('.search-item').forEach(item => {
            item.addEventListener('click', function() {
                const studentId = this.dataset.id;
                const student = studentDatabase.find(s => s.id === studentId);
                if (student) {
                    selectStudent(student);
                    resultsDiv.style.display = 'none';
                }
            });
        });
    }
    
    function selectStudent(student) {
        selectedStudent = student;
        
        document.getElementById('studentID').value = student.id;
        document.getElementById('studentName').value = student.name;
        document.getElementById('studentLevel').value = `Level ${student.level}`;
        document.getElementById('studentProgramme').value = student.programme;
        document.getElementById('studentInfo').style.display = 'block';
        document.getElementById('studentSearch').value = student.id;
        
        showToast(`Selected: ${student.name}`, 'success');
    }
    
    // ============== FORM SUBMISSION ==============
    async function submitToGoogleSheets(formData) {
        showLoading('Submitting record...');
        
        try {
            // Submit via Google Apps Script
            const response = await submitViaGoogleAppsScript(formData);
            
            if (response && response.success !== false) {
                showToast('‚úÖ Record submitted successfully!', 'success');
                clearForm();
                saveExecutiveInfo();
            } else {
                throw new Error(response?.error || 'Submission failed');
            }
            
        } catch (error) {
            console.error('Submission error:', error);
            
            // Save locally for offline submission
            savePendingSubmission(formData);
            showToast('üì± Saved offline. Will submit when online.', 'warning');
            
        } finally {
            hideLoading();
        }
    }
    
    async function submitViaGoogleAppsScript(formData) {
        const scriptUrl = CONFIG.SUBMISSION_ENDPOINT;
        
        try {
            const response = await fetch(scriptUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            });
            
            // Try to parse response
            const text = await response.text();
            try {
                return JSON.parse(text);
            } catch (e) {
                return { success: true, message: 'Submitted successfully' };
            }
            
        } catch (error) {
            console.error('Fetch error:', error);
            throw error;
        }
    }
    
    function savePendingSubmission(formData) {
        const pending = JSON.parse(localStorage.getItem('uhas_pending') || '[]');
        const submissionId = Date.now();
        
        pending.push({
            id: submissionId,
            ...formData,
            timestamp: new Date().toISOString(),
            status: 'pending'
        });
        
        localStorage.setItem('uhas_pending', JSON.stringify(pending));
        updatePendingCount();
        
        console.log(`Saved pending submission ID: ${submissionId}`);
    }
    
    // ============== EVENT HANDLERS ==============
    function setupEventListeners() {
        // Block selection
        document.querySelectorAll('.block-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.block-btn').forEach(b => {
                    b.classList.remove('selected');
                });
                
                this.classList.add('selected');
                selectedBlock = this.dataset.block;
                
                // Show room selection
                document.getElementById('roomSection').classList.add('active');
                
                // Clear room selection
                selectedRoom = "";
                document.querySelectorAll('.room-btn').forEach(r => {
                    r.classList.remove('selected');
                });
                
                showToast(`Selected ${selectedBlock} block`, 'info');
            });
        });
        
        // Room selection
        document.getElementById('roomsGrid').addEventListener('click', function(e) {
            if (e.target.classList.contains('room-btn')) {
                document.querySelectorAll('.room-btn').forEach(r => {
                    r.classList.remove('selected');
                });
                
                e.target.classList.add('selected');
                selectedRoom = e.target.dataset.room;
                
                showToast(`Selected: ${selectedBlock}, Room ${selectedRoom}`, 'success');
            }
        });
        
        // Form submission
        document.getElementById('auditForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!validateForm()) return;
            
            const formData = {
                executiveName: document.getElementById('executiveName').value.trim(),
                executiveID: document.getElementById('executiveID').value.trim(),
                auditDate: document.getElementById('auditDate').value,
                studentID: selectedStudent.id,
                studentName: selectedStudent.name,
                studentLevel: selectedStudent.level,
                studentProgramme: selectedStudent.programme,
                block: selectedBlock,
                room: selectedRoom,
                bedSpace: document.getElementById('bedSpace').value || 'Not Specified',
                notes: document.getElementById('notes').value.trim() || '',
                submissionTime: new Date().toISOString(),
                deviceInfo: navigator.userAgent,
                appVersion: '1.0.0'
            };
            
            await submitToGoogleSheets(formData);
        });
        
        // Clear form
        document.getElementById('clearBtn').addEventListener('click', clearForm);
    }
    
    function validateForm() {
        if (!selectedStudent) {
            showToast('Please select a student first', 'error');
            return false;
        }
        
        if (!selectedBlock) {
            showToast('Please select a hostel block', 'error');
            return false;
        }
        
        if (!selectedRoom) {
            showToast('Please select a room number', 'error');
            return false;
        }
        
        const execName = document.getElementById('executiveName').value.trim();
        const execID = document.getElementById('executiveID').value.trim();
        
        if (!execName || !execID) {
            showToast('Please fill in your executive details', 'error');
            return false;
        }
        
        return true;
    }
    
    // ============== UTILITY FUNCTIONS ==============
    function clearForm() {
        selectedStudent = null;
        selectedBlock = "";
        selectedRoom = "";
        
        document.getElementById('studentSearch').value = '';
        document.getElementById('studentInfo').style.display = 'none';
        
        document.getElementById('roomSection').classList.remove('active');
        
        document.querySelectorAll('.block-btn').forEach(b => b.classList.remove('selected'));
        document.querySelectorAll('.room-btn').forEach(b => b.classList.remove('selected'));
        
        document.getElementById('bedSpace').value = '';
        document.getElementById('notes').value = '';
        
        // Keep executive info and date
        document.getElementById('auditDate').valueAsDate = new Date();
        
        showToast('Form cleared', 'info');
    }
    
    function generateRoomButtons() {
        const roomsGrid = document.getElementById('roomsGrid');
        roomsGrid.innerHTML = '';
        
        for (let i = 1; i <= 40; i++) {
            const roomBtn = document.createElement('div');
            roomBtn.className = 'room-btn';
            roomBtn.dataset.room = i;
            roomBtn.textContent = i;
            roomsGrid.appendChild(roomBtn);
        }
    }
    
    function updateOnlineStatus() {
        const statusDiv = document.getElementById('syncStatus');
        
        if (navigator.onLine) {
            statusDiv.className = 'sync-status online';
            statusDiv.innerHTML = '<i class="fas fa-wifi"></i> <span id="statusText">Online</span>';
            
            // Try to sync pending submissions
            syncPendingSubmissions();
            
        } else {
            statusDiv.className = 'sync-status offline';
            statusDiv.innerHTML = '<i class="fas fa-wifi-slash"></i> <span id="statusText">Offline</span>';
        }
    }
    
    function updateStatus(text) {
        const statusText = document.getElementById('statusText');
        if (statusText) {
            statusText.textContent = text;
        }
    }
    
    async function syncPendingSubmissions() {
        const pending = JSON.parse(localStorage.getItem('uhas_pending') || '[]');
        if (pending.length === 0) return;
        
        showToast(`Syncing ${pending.length} pending submission(s)...`, 'info');
        
        const failed = [];
        
        for (const submission of pending) {
            try {
                // Remove the id and timestamp before sending
                const { id, timestamp, status, ...formData } = submission;
                await submitViaGoogleAppsScript(formData);
                console.log(`Synced pending submission: ${id}`);
            } catch (error) {
                console.error('Failed to sync:', error);
                failed.push(submission);
            }
        }
        
        // Update pending list
        localStorage.setItem('uhas_pending', JSON.stringify(failed));
        
        if (failed.length === 0) {
            showToast('‚úÖ All pending submissions synced', 'success');
        } else {
            showToast(`‚ö†Ô∏è ${failed.length} submissions still pending`, 'warning');
        }
        
        updatePendingCount();
    }
    
    function updatePendingCount() {
        const pending = JSON.parse(localStorage.getItem('uhas_pending') || '[]');
        const statusText = document.getElementById('statusText');
        
        if (pending.length > 0 && statusText && navigator.onLine) {
            statusText.textContent = `Online (${pending.length} pending)`;
        }
    }
    
    function updateStudentCount() {
        const count = studentDatabase.length;
        const lastUpdated = localStorage.getItem('uhas_student_db_updated');
        const date = lastUpdated ? new Date(lastUpdated).toLocaleDateString() : 'Never';
        
        document.getElementById('studentCount').innerHTML = 
            `<strong>${count}</strong> students loaded<br>
            <small style="color: #888; font-size: 10px;">
                Last updated: ${date}
            </small>`;
    }
    
    function loadExecutiveInfo() {
        const savedName = localStorage.getItem('uhas_exec_name');
        const savedID = localStorage.getItem('uhas_exec_id');
        
        if (savedName) document.getElementById('executiveName').value = savedName;
        if (savedID) document.getElementById('executiveID').value = savedID;
    }
    
    function saveExecutiveInfo() {
        localStorage.setItem('uhas_exec_name', document.getElementById('executiveName').value);
        localStorage.setItem('uhas_exec_id', document.getElementById('executiveID').value);
    }
    
    function showLoading(text) {
        document.getElementById('loading').style.display = 'flex';
        document.getElementById('loadingText').textContent = text;
    }
    
    function hideLoading() {
        document.getElementById('loading').style.display = 'none';
    }
    
    function showToast(message, type = 'info') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = 'toast';
        
        switch(type) {
            case 'success': 
                toast.style.background = 'var(--accent)'; 
                break;
            case 'error': 
                toast.style.background = 'var(--danger)'; 
                break;
            case 'warning': 
                toast.style.background = 'var(--warning)'; 
                break;
            default: 
                toast.style.background = 'var(--primary)';
        }
        
        toast.classList.add('show');
        
        setTimeout(() => {
            toast.classList.remove('show');
        }, 3000);
    }
    
    function createRefreshButton() {
        const refreshBtn = document.createElement('button');
        refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i>';
        refreshBtn.title = 'Refresh Database';
        refreshBtn.style.cssText = `
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s;
        `;
        
        refreshBtn.onmouseover = () => refreshBtn.style.transform = 'scale(1.1)';
        refreshBtn.onmouseout = () => refreshBtn.style.transform = 'scale(1)';
        refreshBtn.onclick = () => {
            showToast('Refreshing student database...', 'info');
            loadStudentDatabase();
        };
        
        document.body.appendChild(refreshBtn);
    }
    
    // Export functions for button onclick
    window.loadStudentDatabase = loadStudentDatabase;
</script>
</body>
</html>
